\section{Whistle Source Direction Estimation}
\label{subsec:03_directionEstimation}

% started with \ac{WSDE}
Considering only one stand-alone system, i.e. one robot with four microphones,
only the direction of a sound source can be
estimated.
As shortly introduced in \cref{subsec:03_whistleLocalizationStructure},
the \lstinline!WhistleDirectionEstimation! module is responsible to
determine the direction of the whistle-sound detected by the \lstinline!WhistleDetection!.
Before going into detail, the overall structure of the \ac{WSDE} on a single robot
is summarized by means of \cref{fig:04_stateMachine}.
% -------------------------------------------------------------

\begin{figure}[ht]
	\centering
		\includegraphics[height=0.7\textheight]{figures/state_machine}
	\caption{Concept of whistle localization on single robot.}
	\label{fig:04_stateMachine}
\end{figure}
% -------------------------------------------------------------

\lstinline!WhistleDirectionEstimation! depends on the data type \lstinline!WhistleData!
which is produced by the \lstinline!WhistleDetection! module and contains two values.
A timestamp when the whistle was last detected
and a boolean value if a whistle start is found.
Until this value is set to true by the \lstinline!WhistleDetection!, the
\lstinline!WhistleDirectionEstimation! buffers up to
44100 audio samples per channel.
As a whistle needs to be detected for multiple cycles in a short time, one can
be sure that the buffer contains a number of whistle samples.

Out of the buffered samples, the signal start is calculated
according to the selected signal start detection
which will be further described in \cref{subsec:03_signalStartDetection}.

Frames considered for the delay estimation
are chosen in a different way depending on the \ac{TDOA} method.
Detailed descriptions are given in the corresponding method
\cref{subsubsec:03_cc,subsubsec:03_phase}.
Using \ac{TDOA}, the delays between two microphone channels are either
determined by \ac{CC}, \ac{GCC-PHAT} or the phase difference method.
As previously stated, there exist various \ac{GCC} filter.
However, in this work by \ac{GCC} the \ac{GCC-PHAT} method is always referenced
if not explicitly specified differently.
Each delay generates two potential source direction candidates as stated
in \cref{sec:02_tdoa}.
In the event of candidates indicating a nearby signal from straight forward or
backwards, the distance to the source is estimated in addition.
More precise explanation is given in \cref{subsec:03_distance}.
For a final direction, the mean of the candidates with smallest difference
is formed.
This means that each candidate of a channel pair is compared to the other resulting candidates
of the remaining channel combinations.
The combination with the smallest sum of angular error between the candidates is selected as
\acl{WSDE}.

If one of the correlation methods is used, the \ac{TDOA} is calculated
multiple times by shifting the sample selection window to find the most
suitable frame for the \ac{TDOA} estimation.
Both the shift range around the start index, as well as the size of the shift are
parameterized values.
This way, potential start estimation inaccuracies can be corrected and
the decision process is optimized.
In case of the \ac{GCC-PHAT}, the \ac{PSNR} provides information about
the certainty of the \ac{TDOA} estimation what is shown in \cref{subsec:04_psnr}.
A computation of one frame delivers \ac{TDOA} values for each channel pair and a
mean of all \acp{PSNR} from the \ac{GCC} functions.
Comparing the frame shifts, the \ac{TDOA} results with
greatest \ac{PSNR} mean value is assumed as best performing.
The same procedure is done with the \ac{CC} method but by examining
the maximum \ac{CC} function value.

Regardless of the method, the production of this module is a
\lstinline!WhistleDirection! data type which contains calculated
direction outcome in radians and additional information like distance or \ac{PSNR}.

All transformations into frequency domain and inverse transformations
are executed with the \ac{FFTW} library just as the \lstinline!WhistleDetection!.
For parallel development in Python, the widespread package \textit{NumPy 1.17.0} delivers
all fundamental functions for computation in frequency domain.

% -------------------------------------------------------------

\input{content/03_signalStartDetection}
\input{content/03_tdoa}
\input{content/03_directionEstimation}
\input{content/03_additionalInfo}
% -------------------------------------------------------------